name: Cleanup old directories

on:
  workflow_dispatch: # Ermöglicht manuelles Ausführen

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # WICHTIG: vollständige History laden!


      - name: Debugging Zeige Verzeichnisstruktur
        run: |
          echo "Aktuelles Verzeichnis: $(pwd)"
          echo "Inhalt des Arbeitsverzeichnisses:"
          ls -lah

      - name: Set cutoff date (180 Tage)
        run: |
          # Heutiges Datum (Unix Timestamp)
          NOW=$(date -u +%s)

          # 180 Tage in Sekunden
          CUTOFF_SECONDS=$((180 * 24 * 60 * 60))
          echo "NOW=$NOW" >> $GITHUB_ENV
          echo "CUTOFF_SECONDS=$CUTOFF_SECONDS" >> $GITHUB_ENV

          echo "Aktueller Timestamp: $NOW"
          echo "Grenzwert in Sekunden: $CUTOFF_SECONDS"

      - name: Debugging Suche nach Verzeichnissen
        run: |
          echo "Suche nach Verzeichnissen im Arbeitsverzeichnis:"
          find . -maxdepth 1 -type d -regextype posix-egrep -regex './[0-9]{8}'

      - name: Lösche Verzeichnisse älter als 180 Tage
        run: |
          for dir in $(find . -maxdepth 1 -type d -regextype posix-egrep -regex './[0-9]{8}'); do
            dir_name=$(basename "$dir")
            echo "Gefundenes Verzeichnis: $dir_name"

            # Datum des Verzeichnisses in Timestamp umwandeln
            DIR_TS=$(date -u -d "$dir_name" +%s 2>/dev/null || echo "")

            if [[ -z "$DIR_TS" ]]; then
              echo "Überspringe ungültiges Datumsverzeichnis: $dir_name"
              continue
            fi

            AGE=$((NOW - DIR_TS))

            echo "Verzeichnis $dir_name ist $AGE Sekunden alt."

            if (( AGE > CUTOFF_SECONDS )); then
              echo "Lösche: $dir_name (älter als 180 Tage)"
              rm -rf "$dir"
            else
              echo "Behalte: $dir_name (jünger oder genau 180 Tage)"
            fi
          done

      - name: Commit und Push Änderungen
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add -A
          git add -u
      
          if git diff --staged --quiet; then
            echo "Keine Änderungen zum Commit."
            exit 0
          fi
      
          git commit -m "Automatische Bereinigung alter Verzeichnisse (älter als 180 Tage)"
      
          # Sicherer Push – ohne Rebase, ohne Konflikte
          git push --force-with-lease
